let sortDirections = Array(9).fill(true);
let dateIndex = 0;// ÂàùÂßãÊéíÂ∫èÊñπÂêë
$(function () {
    document.getElementById('hot_content').innerHTML = '';
    document.getElementById('rise_content').innerHTML = '';
    getPopularHotStockData('normal');
    getPopularRiseStockData('skyrocket');
})

function getPopularHotStockData() {
    window.encryptionUtil.fetchDecrypted(`getPopularStockList?type=${encodeURIComponent('normal')}`, { method: 'GET' })
        .then(function (data) {
            console.log(data)
            buildPopularHotStockHtml(data);
        })
        .catch(function (error) {
            console.log('getPopularHotStockData ËØ∑Ê±ÇÂ§±Ë¥•:', error);
        });
}
function downLoadHotBoardAndConceptData() {
    window.encryptionUtil.fetchDecrypted(`downLoadHotBoardAndConceptData?type=${encodeURIComponent('normal')}`, { method: 'GET' })
        .then(function (data) {
            console.log(data)
            buildPopularHotStockHtml(data);
        })
        .catch(function (error) {
            console.log('downLoadHotBoardAndConceptData ËØ∑Ê±ÇÂ§±Ë¥•:', error);
        });
}



function getPopularRiseStockData() {
    window.encryptionUtil.fetchDecrypted(`getPopularStockList?type=${encodeURIComponent('skyrocket')}`, { method: 'GET' })
        .then(function (data) {
            console.log(data)
            buildPopularRiseStockHtml(data);
        })
        .catch(function (error) {
            console.log('getPopularRiseStockData ËØ∑Ê±ÇÂ§±Ë¥•:', error);
        });
}

function buildPopularHotStockHtml(data) {
    var htmlArray = '';
    var tagList = '';
    htmlArray += `<div class="section-header">
                    <h2 class="section-title">üëÄ Â§ßÂÆ∂Âú®Áúã</h2>
                    <div class="time-filter">
                        <span class="time-tab active">1Â∞èÊó∂</span>
                        <span class="time-tab">24Â∞èÊó∂</span>
                    </div>
                </div>`

    data.forEach((stock, stockIndex) => {
            const showAnalyze = stock.analyse == null ? 'hidden' : '';
            const showAnalyseTitle = stock.analyse_title == null ? 'hidden' : '';
            htmlArray += `  
           <!-- ËÇ°Á•®Êù°ÁõÆ -->
                <div class="stock-item">
                    <div class="stock-header">
                        <div>
                            <span class="stock-rank">${stock.order}</span>
                            <span class="stock-name">${stock.name}-${stock.code}</span>
                            <span class="stock-change change-up">${safeToFixed(stock.rise_and_fall)}%</span>
                        </div>
                        <span class="heat">${safeToFixed(stock.rate / 10000)}‰∏áÁÉ≠Â∫¶</span>
                    </div>
                    <div class="tag-group">
                        <span class="populartag">${stock.tag.popularity_tag}</span>`;
            tagList = stock.tag.concept_tag;
            tagList.forEach((tag, tagIndex) => {
                htmlArray += `
                                <span class="populartag">${tag}</span>`
            });
            htmlArray += `   </div>
                    <div class="hot-reason ${showAnalyze}">
                        ${stock.analyse}
                    </div>
                    <div class="hot-reason">
                    <span class="populartag ${showAnalyseTitle}"> ${stock.analyse_title}</span>
                    </div>
                </div>`;
        }
    );

    document.getElementById('hot_content').innerHTML = htmlArray;

}

function buildPopularRiseStockHtml(data) {
    var htmlArray = '';
    var tagList = '';
    htmlArray += `<div class="section-header">
                    <h2 class="section-title">üöÄ Âø´ÈÄüÈ£ôÂçá</h2>
                    <div class="time-filter">
                        <span class="time-tab active">1Â∞èÊó∂</span>
                        <span class="time-tab">24Â∞èÊó∂</span>
                    </div>
                </div>`

    data.forEach((stock, stockIndex) => {
            const showPopularTag = stock.popularity_tag == null ? 'hidden' : '';
            htmlArray += `  
           <!-- ËÇ°Á•®Êù°ÁõÆ -->
                <div class="stock-item">
                    <div class="stock-header">
                        <div>
                            <span class="stock-rank">${stock.order}</span>
                            <span class="stock-name">${stock.name}-${stock.code}</span>
                            <span class="stock-change change-up">${safeToFixed(stock.rise_and_fall)}%</span>
                        </div>
                        <span class="heat">${safeToFixed(stock.rate / 10000)}‰∏áÁÉ≠Â∫¶</span>
                    </div>
                    <div class="tag-group">
                        <span class="populartag ${showPopularTag}">${stock.tag == null ? '' : stock.tag.popularity_tag}</span>`;
            if (stock.tag != null && stock.tag.concept_tag != null) {
                stock.tag.concept_tag.forEach((tag, tagIndex) => {
                    htmlArray += `
                                <span class="populartag">${tag}</span>`
                });
            }

            htmlArray += `   </div>
                </div>`;
        }
    );
    document.getElementById('rise_content').innerHTML = htmlArray;

}

document.addEventListener('DOMContentLoaded', function () {
    // 2. Ëé∑ÂèñÊâÄÊúâÂØºËà™Ê†áÁ≠æÂÖÉÁ¥†
    const tabs = document.querySelectorAll('.nav-tab');

    // 3. ÈÅçÂéÜÁªëÂÆöÁÇπÂáª‰∫ã‰ª∂
    tabs.forEach(tab => {
        tab.addEventListener('click', function () {
            // 4. ÁßªÈô§ÊâÄÊúâÊ†áÁ≠æÁöÑÊøÄÊ¥ªÁä∂ÊÄÅ
            tabs.forEach(t => t.classList.remove('active'));

            // 5. Ê∑ªÂä†ÂΩìÂâçÊ†áÁ≠æÊøÄÊ¥ªÁä∂ÊÄÅ
            this.classList.add('active');

            // 6. Ê†πÊçÆÊ†áÁ≠æÁ±ªÂûãÊâßË°åÂØπÂ∫îÊìç‰Ωú
            const tabType = this.textContent.trim();
            document.getElementById('hot_content').innerHTML = '';
            document.getElementById('rise_content').innerHTML = '';
            if (tabType === 'ÁÉ≠ËÇ°') {
                getPopularHotStockData();
                getPopularRiseStockData()
            } else if (tabType === 'ÊùøÂùó') {
                console.log('ÊùøÂùó')
                getPopularHotConceptData()
                getPopularHotIndustryData()
            } else if (tabType === '‰∏úÊñπË¥¢ÂØå') {
                getPopularHotDongCaiData();
            }
        });
    });
});

function getPopularHotIndustryData() {
    window.encryptionUtil.fetchDecrypted(`getPopularStockList?type=${encodeURIComponent('normal')}`, { method: 'GET' })
        .then(function (data) {
            console.log(data)
            getPopularHotIndustryData(data);
        })
        .catch(function (error) {
            console.log('getPopularHotIndustryData ËØ∑Ê±ÇÂ§±Ë¥•:', error);
        });
}

function getPopularHotConceptData() {
    window.encryptionUtil.fetchDecrypted(`getPopularConceptList?type=${encodeURIComponent('concept')}`, { method: 'GET' })
        .then(function (data) {
            console.log(data)
            buildPopularHotConceptHtml(data);
        })
        .catch(function (error) {
            console.log('getPopularHotConceptData ËØ∑Ê±ÇÂ§±Ë¥•:', error);
        });
}

function getPopularHotIndustryData() {
    window.encryptionUtil.fetchDecrypted(`getPopularConceptList?type=${encodeURIComponent('industry')}`, { method: 'GET' })
        .then(function (data) {
            console.log(data)
            buildPopularIndustryHtml(data);
        })
        .catch(function (error) {
            console.log('getPopularHotIndustryData ËØ∑Ê±ÇÂ§±Ë¥•:', error);
        });
}

function buildPopularIndustryHtml(data) {
    var htmlArray = '';
    var tagList = '';
    htmlArray += `<div class="section-header">
                    <h2 class="section-title">ÁÉ≠Èó®ÊùøÂùó</h2>
<!--                    <div class="time-filter">-->
<!--                        <span class="time-tab active">1Â∞èÊó∂</span>-->
<!--                        <span class="time-tab">24Â∞èÊó∂</span>-->
<!--                    </div>-->
                </div>`

    data.forEach((stock, stockIndex) => {
            const showHotTag = stock.hot_tag == null ? 'hidden' : '';
            const showPopularTag = stock.tag == null ? 'hidden' : '';
            htmlArray += `  
           <!-- ËÇ°Á•®Êù°ÁõÆ -->
                <div class="stock-item">
                    <div class="stock-header">
                        <div>
                            <span class="stock-rank">${stock.order}</span>
                            <span class="stock-name">${stock.name}-${stock.code}</span>
                            <span class="stock-change change-up">${safeToFixed(stock.rise_and_fall)}%</span>
                        </div>
                        <span class="heat">${safeToFixed(stock.rate / 10000)}‰∏áÁÉ≠Â∫¶</span>
                    </div>
                    <div class="tag-group">
                        <span class="populartag ${showHotTag}">${stock.hot_tag}</span>
                        <span class="populartag ${showPopularTag}">${stock.tag}</span>
                    </div>
                </div>`;
        }
    );

    document.getElementById('rise_content').innerHTML = htmlArray;

}

function buildPopularHotConceptHtml(data) {
    var htmlArray = '';
    var tagList = '';
    htmlArray += `<div class="section-header">
                    <h2 class="section-title">ÁÉ≠Èó®Ê¶ÇÂøµ</h2>
<!--                    <div class="time-filter">-->
<!--                        <span class="time-tab active">1Â∞èÊó∂</span>-->
<!--                        <span class="time-tab">24Â∞èÊó∂</span>-->
<!--                    </div>-->
                </div>`

    data.forEach((stock, stockIndex) => {
            const showHotTag = stock.hot_tag == null ? 'hidden' : '';
            const showPopularTag = stock.tag == null ? 'hidden' : '';
            htmlArray += `  
           <!-- ËÇ°Á•®Êù°ÁõÆ -->
                <div class="stock-item">
                    <div class="stock-header">
                        <div>
                            <span class="stock-rank">${stock.order}</span>
                            <span class="stock-name">${stock.name}-${stock.code}</span>
                            <span class="stock-change change-up">${safeToFixed(stock.rise_and_fall)}%</span>
                        </div>
                        <span class="heat">${safeToFixed((stock.rate / 10000))}‰∏áÁÉ≠Â∫¶</span>
                    </div>
                    <div class="tag-group">
                        <span class="populartag ${showHotTag}">${stock.hot_tag}</span>
                        <span class="populartag ${showPopularTag}">${stock.tag}</span>
                    </div>
                </div>`;
        }
    );

    document.getElementById('hot_content').innerHTML = htmlArray;

}

function getPopularHotDongCaiData() {
    window.encryptionUtil.fetchDecrypted(`getDongCaiPopularStocktList`, { method: 'GET' })
        .then(function (data) {
            console.log(data)
            buildPopularDongCaiHtml(data);
        })
        .catch(function (error) {
            console.log('getPopularHotDongCaiData ËØ∑Ê±ÇÂ§±Ë¥•:', error);
        });
}

function buildPopularDongCaiHtml(data) {
    var htmlArray = '';
    var tagList = '';
    htmlArray += `<div class="section-header">
                    <h2 class="section-title">ÁÉ≠Èó®‰∏™ËÇ°</h2>
<!--                    <div class="time-filter">-->
<!--                        <span class="time-tab active">1Â∞èÊó∂</span>-->
<!--                        <span class="time-tab">24Â∞èÊó∂</span>-->
<!--                    </div>-->
                </div>`

    data.forEach((stock, stockIndex) => {
            htmlArray += `  
           <!-- ËÇ°Á•®Êù°ÁõÆ -->
                <div class="stock-item">
                    <div class="stock-header">
                        <div>
                            <span class="stock-rank">${stockIndex + 1}</span>
                            <span class="stock-name">${stock.f14}-${stock.f12}</span>
                            <span class="stock-change change-up">${safeToFixed(stock.f3)}%</span>
                        </div>
                    </div>
                </div>`;
        }
    );

    document.getElementById('hot_content').innerHTML = htmlArray;

}


// ÁÆÄÂçïÁöÑXSSËΩ¨‰πâÂáΩÊï∞
function escapeHtml(unsafe) {
    return unsafe.toString()
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
}

function refreshData() {
    document.getElementById('hot_content').innerHTML = '';
    document.getElementById('rise_content').innerHTML = '';
    getPopularHotStockData('normal');
    getPopularRiseStockData('skyrocket');
}

function preDayData() {
    dateIndex++;
    getStrongStockData();
}

function sortTable(orderFiled, orderBy) {
    document.getElementById('pool').innerHTML = '';
    getLimitPoolData(orderFiled, orderBy);
    // Êõ¥Êñ∞ÊéíÂ∫èÊåáÁ§∫Âô®
    // updateSortIndicator(column);
}


function updateSortIndicator(column) {
    const indicators = document.querySelectorAll(".sort-indicator");
    indicators.forEach(ind => ind.textContent = "");
    // indicators[column].textContent = sortDirections[column] ? "‚ñº" : "‚ñ≤";
}

function safeToFixed(value, decimals = 2) {
    return (Number(value) || 0).toFixed(decimals);
}


function showTooltip(event) {
    // Ëé∑ÂèñÂΩìÂâçÂçïÂÖÉÊ†ºÂÜÖÁöÑÊèêÁ§∫Ê°Ü
    const tooltip = event.target.querySelector('.reason-tooltip');
    if (tooltip) {
        // ËÆæÁΩÆÊèêÁ§∫Ê°ÜÁöÑÊòæÁ§∫Áä∂ÊÄÅ
        tooltip.style.display = 'block';
        // ËÆ°ÁÆóÊèêÁ§∫Ê°ÜÁöÑ‰ΩçÁΩÆÔºåÈÅøÂÖçË∂ÖÂá∫Â±èÂπïËæπÁïå
        const rect = event.target.getBoundingClientRect();
        tooltip.style.left = `${rect.left + window.scrollX}px`;
        tooltip.style.top = `${rect.bottom + window.scrollY}px`;
    }
}

function hideTooltip(event) {
    // Ëé∑ÂèñÂΩìÂâçÂçïÂÖÉÊ†ºÂÜÖÁöÑÊèêÁ§∫Ê°Ü
    const tooltip = event.target.querySelector('.reason-tooltip');
    if (tooltip) {
        // ÈöêËóèÊèêÁ§∫Ê°Ü
        tooltip.style.display = 'none';
    }
}

function showFullReason(content) {
    this.fullReasonContent = content;
    // ÂàõÂª∫ËØ¶ÊÉÖÂºπÁ™ó
    const div = document.createElement('div');
    div.className = 'reason-full active';
    div.innerHTML = `
                <div class="reason-content">${content}</div>
                <span class="close-btn" onclick="this.parentElement.remove()">√ó</span>
            `;
    document.body.appendChild(div);
}